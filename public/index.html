<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet AI Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .nav-item.active { background-color: #4f46e5; color: white; }
        .page { display: none; }
        .page.active { display: block; }
        .chat-bubble { max-width: 80%; }
        .chat-bubble-user { background-color: #4f46e5; color: white; }
        .chat-bubble-ai { background-color: #ffffff; color: #334155; }
        .file-upload-wrapper { border: 2px dashed #cbd5e1; }
        .file-upload-wrapper.dragover { border-color: #4f46e5; background-color: #eef2ff; }
        .tab-btn.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <!-- Pet Info Container -->
    <div id="pet-info-container" class="w-full h-screen flex items-center justify-center bg-slate-100">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-3xl font-bold text-center text-indigo-600 mb-2">Pet AI Care</h2>
                <p class="text-center text-slate-500 mb-8">반려동물 정보를 입력해주세요.</p>
                <form id="pet-info-form">
                    <div class="mb-4">
                        <label for="pet-name" class="block text-slate-700 font-semibold mb-2">이름</label>
                        <input type="text" id="pet-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="pet-breed" class="block text-slate-700 font-semibold mb-2">품종</label>
                        <input type="text" id="pet-breed" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="pet-age" class="block text-slate-700 font-semibold mb-2">나이</label>
                        <input type="number" id="pet-age" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="pet-weight" class="block text-slate-700 font-semibold mb-2">몸무게 (kg)</label>
                        <input type="number" step="0.01" id="pet-weight" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-colors">시작하기</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="h-screen flex-grow flex hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
            <div class="h-20 flex items-center justify-center border-b"><h1 class="text-2xl font-bold text-indigo-600 flex items-center"><i data-lucide="cat" class="mr-2"></i> Pet AI Care</h1></div>
            <nav class="flex-grow p-4">
                <ul class="space-y-2">
                    <li><a href="#" class="nav-item flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors active" data-page="health-check"><i data-lucide="scan-eye" class="mr-3"></i>AI 건강 체크</a></li>
                    <li><a href="#" class="nav-item flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors" data-page="video-analysis"><i data-lucide="video" class="mr-3"></i>영상 분석</a></li>
                    <li><a href="#" class="nav-item flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors" data-page="ai-assistant"><i data-lucide="cpu" class="mr-3"></i>AI 도우미</a></li>
                    <li><a href="#" class="nav-item flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors" data-page="chat"><i data-lucide="message-circle" class="mr-3"></i>AI 챗봇</a></li>
                    <li><a href="#" class="nav-item flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors" data-page="vets"><i data-lucide="stethoscope" class="mr-3"></i>병원 찾기</a></li>
                </ul>
            </nav>
            <div class="p-4 border-t">
                <div class="flex items-center">
                    <img id="pet-sidebar-img" src="https://placehold.co/40x40/e0e7ff/4338ca?text=Pet" class="rounded-full" alt="Pet Avatar">
                    <div class="ml-3">
                        <p id="pet-sidebar-name" class="font-semibold text-sm truncate">반려동물</p>
                        <a href="#" id="edit-pet-info-btn" class="text-sm text-slate-500 hover:text-indigo-600">정보 수정</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 bg-slate-100 p-8 overflow-y-auto">
            <!-- AI Health Check Page -->
            <div id="health-check" class="page active">
                <header class="mb-6"><h2 class="text-3xl font-bold text-slate-800">AI 건강 체크</h2><p id="health-check-subtitle" class="text-slate-500">반려동물의 피부, 눈, 귀 등의 사진을 올려 AI에게 예비 분석을 요청하세요.</p></header>
                <div class="bg-white rounded-xl shadow-sm p-6"><div id="fileUploadWrapper" class="file-upload-wrapper rounded-lg p-8 text-center cursor-pointer hover:bg-slate-50 transition-colors"><i data-lucide="upload-cloud" class="w-16 h-16 mx-auto text-slate-400"></i><p class="mt-4 font-semibold text-slate-700">분석할 사진을 여기에 드래그하거나 클릭하세요</p><p class="text-sm text-slate-500">피부, 눈, 귀 등 상태를 확인할 부위를 선명하게 찍어주세요.</p><input type="file" id="imageUpload" class="hidden" accept="image/*"></div><div id="imagePreviewContainer" class="mt-6 text-center hidden"><img id="imagePreview" src="" alt="Image Preview" class="max-w-xs max-h-64 mx-auto rounded-lg shadow-md"><button id="analyzeImageBtn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center mx-auto"><span class="mr-2">✨</span> AI 분석 시작하기</button></div></div>
                <div id="analysisResultContainer" class="mt-6 hidden"><h3 class="text-2xl font-bold text-slate-800 mb-4">AI 분석 결과</h3><div id="analysisResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div></div>
            </div>

            <!-- AI Video Analysis Page -->
            <div id="video-analysis" class="page">
                <header class="mb-6"><h2 class="text-3xl font-bold text-slate-800">AI 영상 분석 (프레임)</h2><p id="video-analysis-subtitle" class="text-slate-500">반려동물의 행동 영상(보행, 자세 등)을 올려 AI에게 분석을 요청하세요.</p></header>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div id="videoUploadWrapper" class="file-upload-wrapper rounded-lg p-8 text-center cursor-pointer hover:bg-slate-50 transition-colors">
                        <i data-lucide="video" class="w-16 h-16 mx-auto text-slate-400"></i>
                        <p class="mt-4 font-semibold text-slate-700">분석할 영상을 여기에 드래그하거나 클릭하세요</p>
                        <p class="text-sm text-slate-500">보행, 점프, 자세 등 행동을 확인할 영상을 업로드하세요.</p>
                        <input type="file" id="videoUpload" class="hidden" accept="video/*">
                    </div>
                    <div id="videoPreviewContainer" class="mt-6 text-center hidden">
                        <video id="videoPreview" controls class="max-w-full max-h-96 mx-auto rounded-lg shadow-md"></video>
                        <p class="text-sm text-slate-500 mt-2">영상을 재생하여 분석하고 싶은 장면에서 멈춘 후 버튼을 누르세요.</p>
                        <button id="analyzeVideoBtn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center mx-auto">
                            <span class="mr-2">✨</span> 현재 장면 분석하기
                        </button>
                    </div>
                </div>
                <div id="videoAnalysisResultContainer" class="mt-6 hidden">
                    <h3 class="text-2xl font-bold text-slate-800 mb-4">AI 영상 프레임 분석 결과</h3>
                    <div id="videoAnalysisResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div>
                </div>
                <div class="mt-6 bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">영상 분석 기록</h3>
                    <div id="video-analysis-history" class="space-y-4 max-h-96 overflow-y-auto"><p class="text-slate-500 text-center">아직 분석 기록이 없습니다.</p></div>
                </div>
            </div>

            <!-- AI Assistant Page -->
            <div id="ai-assistant" class="page">
                <header class="mb-6"><h2 class="text-3xl font-bold text-slate-800">AI 도우미</h2><p id="ai-assistant-subtitle" class="text-slate-500">반려동물의 일상 관리, 훈련, 응급 상황 대처까지 AI가 도와드립니다.</p></header>
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-slate-500 hover:text-indigo-600 active" data-tab="lifestyle">일상 관리</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-slate-500 hover:text-indigo-600" data-tab="behavior">행동 분석</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-slate-500 hover:text-indigo-600" data-tab="training">훈련 계획</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-slate-500 hover:text-indigo-600" data-tab="emergency">응급 대처</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-slate-500 hover:text-indigo-600" data-tab="cost-estimator">진료비 예상</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-slate-500 hover:text-indigo-600" data-tab="breed-info">품종 정보</button>
                    </nav>
                </div>

                <div class="tab-content active" data-tab-content="lifestyle">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">"이거 먹어도 되나요?" AI 음식 체크</h3>
                            <label for="foodInput" class="block font-semibold text-slate-700 mb-2">궁금한 음식 이름을 입력하세요:</label>
                            <input id="foodInput" type="text" class="w-full border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="예: 딸기, 요거트">
                            <button id="checkFoodSafetyBtn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center"><span class="mr-2">✨</span> 안전성 확인하기</button>
                            <div id="foodSafetyResultContainer" class="mt-4 hidden"><div id="foodSafetyResult" class="prose max-w-none text-sm p-3 bg-slate-50 rounded-lg"></div></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-xl font-bold text-slate-800 mb-4" id="play-recommend-title">맞춤 AI 놀이 추천</h3>
                            <p class="text-slate-600 mb-4" id="play-recommend-desc">반려동물의 나이와 품종을 고려하여 AI가 맞춤형 놀이와 환경 풍부화 아이디어를 제안합니다.</p>
                            <button id="recommendPlayBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center"><span class="mr-2">✨</span> 놀이 추천받기</button>
                            <div id="playRecommendationResultContainer" class="mt-4 hidden"><div id="playRecommendationResult" class="prose max-w-none text-sm p-3 bg-slate-50 rounded-lg"></div></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">펫시터/병원용 인수인계 노트</h3>
                        <p class="text-slate-600 mb-4" id="handover-desc">반려동물을 맡길 때 필요한 인수인계 노트를 AI가 자동으로 생성해 드립니다.</p>
                        <button id="generateHandoverNoteBtn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> 인수인계 노트 생성하기</button>
                        <div id="handoverNoteResultContainer" class="mt-4 hidden"><h4 id="handover-title" class="text-lg font-bold text-slate-800 mb-2 flex justify-between items-center">인수인계 노트 <button id="copyHandoverNoteBtn" class="text-sm bg-slate-200 text-slate-700 font-semibold py-1 px-3 rounded-lg hover:bg-slate-300">복사하기</button></h4><div id="handoverNoteResult" class="prose max-w-none text-sm p-3 bg-slate-50 rounded-lg"></div></div>
                    </div>
                </div>

                <div class="tab-content" data-tab-content="behavior">
                    <div class="bg-white rounded-xl shadow-sm p-6"><label for="behaviorInput" class="block font-semibold text-slate-700 mb-2" id="behavior-label">분석하고 싶은 반려동물의 행동을 자세히 설명해주세요:</label><textarea id="behaviorInput" rows="4" class="w-full border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="예: 최근 밤에 잠을 안 자고 계속 울어요. 이유가 뭘까요?"></textarea><button id="analyzeBehaviorBtn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> AI 분석 요청하기</button></div>
                    <div id="behaviorResultContainer" class="mt-6 hidden"><h3 class="text-2xl font-bold text-slate-800 mb-4">AI 행동 분석 결과</h3><div id="behaviorResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div></div>
                </div>
                <div class="tab-content" data-tab-content="training">
                    <div class="bg-white rounded-xl shadow-sm p-6"><label for="trainingInput" class="block font-semibold text-slate-700 mb-2">어떤 훈련을 도와드릴까요? 목표를 알려주세요:</label><textarea id="trainingInput" rows="4" class="w-full border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="예: 가구를 긁지 않도록 훈련시키고 싶어요."></textarea><button id="generateTrainingPlanBtn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> AI 훈련 계획 생성하기</button></div>
                    <div id="trainingPlanResultContainer" class="mt-6 hidden"><h3 class="text-2xl font-bold text-slate-800 mb-4">AI 맞춤 훈련 계획</h3><div id="trainingPlanResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div></div>
                </div>
                <div class="tab-content" data-tab-content="emergency">
                    <div class="bg-white rounded-xl shadow-sm p-6"><label for="emergencySituation" class="block font-semibold text-slate-700 mb-2">어떤 응급 상황에 대한 대처법이 궁금하신가요?</label><select id="emergencySituation" class="w-full border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"><option>독성 물질 섭취 (예: 초콜릿, 백합)</option><option>기도 막힘 / 호흡 곤란</option><option>심한 외상 / 골절 의심</option><option>경련 또는 발작</option><option>화상</option></select><button id="generateEmergencyProtocolBtn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> AI 응급 대처 가이드 생성</button></div>
                    <div id="emergencyProtocolResultContainer" class="mt-6 hidden"><h3 class="text-2xl font-bold text-slate-800 mb-4">AI 응급 대처 가이드</h3><div id="emergencyProtocolResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div></div>
                </div>
                <div class="tab-content" data-tab-content="cost-estimator">
                    <div class="bg-white rounded-xl shadow-sm p-6"><label for="symptomInput" class="block font-semibold text-slate-700 mb-2">증상이나 궁금한 진료 항목을 입력하세요:</label><textarea id="symptomInput" rows="4" class="w-full border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="예: 고양이 방광염 진료, 스케일링 비용"></textarea><button id="estimateCostBtn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> AI 진료비 예상하기</button></div>
                    <div id="costEstimateResultContainer" class="mt-6 hidden"><h3 class="text-2xl font-bold text-slate-800 mb-4">AI 진료비 예상 결과</h3><div id="costEstimateResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div></div>
                </div>
                <div class="tab-content" data-tab-content="breed-info">
                    <div class="bg-white rounded-xl shadow-sm p-6"><p class="text-slate-700 mb-4" id="breed-info-desc">반려동물의 품종에 대한 상세 정보를 AI가 생성해 드립니다.</p><button id="generateBreedInfoBtn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> 맞춤 품종 정보 보기</button></div>
                    <div id="breedInfoResultContainer" class="mt-6 hidden"><h3 id="breed-info-title" class="text-2xl font-bold text-slate-800 mb-4">AI 맞춤 품종 정보</h3><div id="breedInfoResult" class="bg-white rounded-xl shadow-sm p-6 prose max-w-none"></div></div>
                </div>
            </div>

            <!-- AI Chatbot Page -->
            <div id="chat" class="page flex flex-col h-full">
                <header class="mb-6"><h2 class="text-3xl font-bold text-slate-800">AI 집사에게 물어보기</h2><p id="chat-subtitle" class="text-slate-500">반려동물에 대해 궁금한 점을 AI에게 물어보세요.</p></header>
                <div id="chatWindow" class="flex-grow bg-white rounded-xl shadow-sm p-4 overflow-y-auto space-y-4"><div class="flex justify-start"><div id="chat-welcome" class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm">안녕하세요! AI 집사입니다. 무엇이 궁금하신가요?</div></div></div>
                <form id="chatForm" class="mt-4 flex items-center space-x-2"><input id="chatInput" type="text" placeholder="메시지를 입력하세요..." class="flex-grow border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-3" required><button type="submit" class="bg-indigo-600 text-white font-semibold p-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><i data-lucide="send" class="w-6 h-6"></i></button></form>
            </div>

            <!-- Vets Page -->
            <div id="vets" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-8">내 주변 동물병원</h2>

                <!-- GPS Location Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <button id="getLocationBtn" class="bg-indigo-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-indigo-700 transition-colors flex items-center flex-shrink-0">
                            <i data-lucide="map-pin" class="w-5 h-5 mr-2"></i> 내 위치 찾기
                        </button>
                        <p id="locationStatus" class="text-slate-500 text-sm">위치 버튼을 눌러 현재 위치를 확인하세요.</p>
                    </div>
                </div>

                <!-- Map Link Buttons -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <button id="openGoogleMapBtn" class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow flex items-center justify-center gap-3 text-slate-400 cursor-not-allowed" disabled>
                        <svg class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        <span class="font-semibold">Google 지도에서 동물병원 검색</span>
                    </button>
                    <button id="openNaverMapBtn" class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow flex items-center justify-center gap-3 text-slate-400 cursor-not-allowed" disabled>
                        <svg class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        <span class="font-semibold">네이버 지도에서 동물병원 검색</span>
                    </button>
                </div>

                <!-- AI Search Section -->
                <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-3">AI 병원 추천</h3>
                    <div class="flex items-center space-x-2"><input id="vetSearchInput" type="text" placeholder="예: 방광염 잘 보고 야간 진료 가능한 곳" class="flex-grow border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"><button id="vetSearchBtn" class="bg-indigo-600 text-white font-semibold p-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><span class="mr-2">✨</span> AI 검색</button></div>
                </div>
                <div id="vetResults" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <!-- Persistent Chat Widget (shown on all pages except dedicated chat page) -->
            <div id="persistent-chat" class="mt-8">
                <header class="mb-4"><h2 class="text-3xl font-bold text-slate-800">✨ AI 집사에게 물어보기</h2><p id="persistent-chat-subtitle" class="text-slate-500">반려동물에 대해 궁금한 점을 AI에게 물어보세요.</p></header>
                <div id="persistentChatWindow" class="bg-white rounded-xl shadow-sm p-4 overflow-y-auto space-y-4 min-h-[120px] max-h-[400px]"><div class="flex justify-start"><div id="persistent-chat-welcome" class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm">안녕하세요! AI 집사입니다. 무엇이 궁금하신가요?</div></div></div>
                <form id="persistentChatForm" class="mt-4 flex items-center space-x-2"><input id="persistentChatInput" type="text" placeholder="메시지를 입력하세요..." class="flex-grow border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-3" required><button type="submit" class="bg-indigo-600 text-white font-semibold p-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center"><i data-lucide="send" class="w-6 h-6"></i></button></form>
            </div>
        </main>
    </div>

    <!-- Gemini Modal -->
    <div id="geminiModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-slate-800"></h3>
            <div id="modalContent" class="text-slate-700 max-h-[60vh] overflow-y-auto pr-2">
                <div id="modalSpinner" class="flex justify-center items-center h-48"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div></div>
                <div id="modalResult" class="prose max-w-none"></div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- GLOBAL STATE ---
        let currentPetData = null;
        let eventListenersInitialized = false;
        let videoAnalysisLogs = [];

        // --- DOM Elements ---
        const petInfoContainer = document.getElementById('pet-info-container');
        const appContainer = document.getElementById('app-container');
        const petInfoForm = document.getElementById('pet-info-form');
        const editPetInfoBtn = document.getElementById('edit-pet-info-btn');

        // --- Helper: Get Pet Context for AI Prompts ---
        function getPetContext() {
            if (!currentPetData) return '';
            return `반려동물 정보 - 이름: ${currentPetData.name}, 품종: ${currentPetData.breed}, 나이: ${currentPetData.age}세, 몸무게: ${currentPetData.weight}kg.`;
        }

        // --- Pet Info Form Submission ---
        petInfoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            currentPetData = {
                name: document.getElementById('pet-name').value,
                breed: document.getElementById('pet-breed').value,
                age: document.getElementById('pet-age').value,
                weight: document.getElementById('pet-weight').value
            };
            initializeAppLogic();
            petInfoContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
        });

        // --- Edit Pet Info ---
        editPetInfoBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPetData) {
                document.getElementById('pet-name').value = currentPetData.name;
                document.getElementById('pet-breed').value = currentPetData.breed;
                document.getElementById('pet-age').value = currentPetData.age;
                document.getElementById('pet-weight').value = currentPetData.weight;
            }
            appContainer.classList.add('hidden');
            petInfoContainer.classList.remove('hidden');
        });

        // --- Gemini API Calls (via Cloudflare Functions Proxy) ---
        async function callGeminiAPI(prompt) {
            const response = await fetch("/api/gemini", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                }),
            });
            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.error || "API 요청에 실패했습니다.");
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error("AI 응답을 처리할 수 없습니다.");
        }

        async function callGeminiVisionAPI(prompt, imageBase64) {
            const response = await fetch("/api/gemini-vision", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: imageBase64 } },
                        ],
                    }],
                }),
            });
            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.error || "Vision API 요청에 실패했습니다.");
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error("AI 응답을 처리할 수 없습니다.");
        }

        // --- Simple Markdown to HTML ---
        function simpleMarkdownToHtml(text) {
            if (!text) return '';
            let html = text
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^\* (.*$)/gm, '<li>$1</li>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
            return html;
        }

        // --- Modal Logic ---
        function openModal(title) {
            const modal = document.getElementById('geminiModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalSpinner').classList.remove('hidden');
            document.getElementById('modalResult').innerHTML = '';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('geminiModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showModalResult(html) {
            document.getElementById('modalSpinner').classList.add('hidden');
            document.getElementById('modalResult').innerHTML = html;
        }

        function showModalError(message) {
            document.getElementById('modalSpinner').classList.add('hidden');
            document.getElementById('modalResult').innerHTML = `<p class="text-red-500">${message}</p>`;
        }

        // --- Navigation Logic ---
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const targetPage = document.getElementById(pageName);
            if (targetPage) targetPage.classList.add('active');
            const targetNav = document.querySelector(`.nav-item[data-page="${pageName}"]`);
            if (targetNav) targetNav.classList.add('active');
            const persistentChat = document.getElementById('persistent-chat');
            if (persistentChat) {
                persistentChat.style.display = (pageName === 'chat') ? 'none' : 'block';
            }
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(item.dataset.page);
            });
        });

        // --- Tab Logic ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                const tabContent = document.querySelector(`[data-tab-content="${btn.dataset.tab}"]`);
                if (tabContent) tabContent.classList.add('active');
            });
        });

        // --- App Initialization ---
        function initializeAppLogic() {
            updatePetUI();
            if (!eventListenersInitialized) {
                setupEventListeners();
                eventListenersInitialized = true;
            }
            lucide.createIcons();
        }

        // --- Update Pet UI ---
        function updatePetUI() {
            if (!currentPetData) return;
            const p = currentPetData;

            // Sidebar
            document.getElementById('pet-sidebar-name').textContent = p.name;
            document.getElementById('pet-sidebar-img').src = `https://placehold.co/40x40/e0e7ff/4338ca?text=${encodeURIComponent(p.name)}`;

            // Page subtitles
            document.getElementById('health-check-subtitle').textContent = `${p.name}의 피부, 눈, 귀 등의 사진을 올려 AI에게 예비 분석을 요청하세요.`;
            document.getElementById('video-analysis-subtitle').textContent = `${p.name}의 행동 영상(보행, 자세 등)을 올려 AI에게 분석을 요청하세요.`;
            document.getElementById('ai-assistant-subtitle').textContent = `${p.name}의 일상 관리, 훈련, 응급 상황 대처까지 AI가 도와드립니다.`;
            document.getElementById('play-recommend-title').textContent = `${p.name} 맞춤 AI 놀이 추천`;
            document.getElementById('play-recommend-desc').textContent = `${p.name}의 나이와 품종을 고려하여 AI가 맞춤형 놀이와 환경 풍부화 아이디어를 제안합니다.`;
            document.getElementById('handover-desc').textContent = `${p.name}를 맡길 때 필요한 인수인계 노트를 AI가 자동으로 생성해 드립니다.`;
            document.getElementById('handover-title').innerHTML = `${p.name} 인수인계 노트 <button id="copyHandoverNoteBtn" class="text-sm bg-slate-200 text-slate-700 font-semibold py-1 px-3 rounded-lg hover:bg-slate-300">복사하기</button>`;
            document.getElementById('behavior-label').textContent = `분석하고 싶은 ${p.name}의 행동을 자세히 설명해주세요:`;
            document.getElementById('breed-info-desc').textContent = `${p.name}의 품종인 '${p.breed}'에 대한 상세 정보를 AI가 생성해 드립니다.`;
            document.getElementById('breed-info-title').textContent = `AI 맞춤 품종 정보: ${p.breed}`;
            document.getElementById('chat-subtitle').textContent = `${p.name}에 대해 궁금한 점을 AI에게 물어보세요.`;
            document.getElementById('chat-welcome').textContent = `안녕하세요! 저는 ${p.name}의 전담 AI 집사입니다. 무엇이 궁금하신가요?`;
            document.getElementById('persistent-chat-subtitle').textContent = `${p.name}에 대해 궁금한 점을 AI에게 물어보세요.`;
            document.getElementById('persistent-chat-welcome').textContent = `안녕하세요! 저는 ${p.name}의 전담 AI 집사입니다. 무엇이 궁금하신가요?`;
        }

        // --- Video Analysis History ---
        function updateVideoAnalysisHistory(logs) {
            const container = document.getElementById('video-analysis-history');
            if (!container) return;
            if (!logs || logs.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center">아직 분석 기록이 없습니다.</p>';
                return;
            }
            container.innerHTML = '';
            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'bg-slate-50 p-4 rounded-lg flex items-start space-x-4';
                div.innerHTML = `
                    <div class="w-16 h-16 bg-slate-200 rounded-lg flex-shrink-0 flex items-center justify-center">
                        <i data-lucide="video" class="w-8 h-8 text-slate-400"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-sm text-slate-800">${log.date || '날짜 없음'}</p>
                        <p class="text-sm text-slate-600 mt-1">${log.summary || ''}</p>
                        <button class="text-sm text-indigo-600 hover:underline mt-1 video-detail-btn">전체 분석 보기</button>
                    </div>
                `;
                container.appendChild(div);
                div.querySelector('.video-detail-btn').addEventListener('click', () => {
                    openModal('영상 분석 상세 결과');
                    document.getElementById('modalSpinner').classList.add('hidden');
                    document.getElementById('modalResult').innerHTML = simpleMarkdownToHtml(log.result || '');
                });
            });
            lucide.createIcons();
        }

        // --- Setup Event Listeners ---
        function setupEventListeners() {

            // Image Upload & Analysis
            const fileUploadWrapper = document.getElementById('fileUploadWrapper');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');

            if (fileUploadWrapper) {
                fileUploadWrapper.addEventListener('click', () => imageUpload.click());
                fileUploadWrapper.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadWrapper.classList.add('dragover'); });
                fileUploadWrapper.addEventListener('dragleave', () => fileUploadWrapper.classList.remove('dragover'));
                fileUploadWrapper.addEventListener('drop', (e) => { e.preventDefault(); fileUploadWrapper.classList.remove('dragover'); if (e.dataTransfer.files.length) handleImageFile(e.dataTransfer.files[0]); });
            }
            if (imageUpload) imageUpload.addEventListener('change', (e) => { if (e.target.files.length) handleImageFile(e.target.files[0]); });

            let currentImageBase64 = '';
            function handleImageFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    currentImageBase64 = e.target.result.split(',')[1];
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            const analyzeImageBtn = document.getElementById('analyzeImageBtn');
            if (analyzeImageBtn) analyzeImageBtn.addEventListener('click', async () => {
                if (!currentImageBase64) return;
                const resultContainer = document.getElementById('analysisResultContainer');
                const resultDiv = document.getElementById('analysisResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `당신은 수의사 AI 보조입니다. ${getPetContext()} 이 반려동물의 사진을 분석해주세요. 피부 상태, 눈 상태, 귀 상태, 전반적인 외형 등을 확인하고, 발견되는 이상 소견이 있다면 설명해주세요. 주의해야 할 사항이 있다면 알려주세요. 이것은 참고용 예비 분석이며 전문 수의사 진료를 대체할 수 없음을 명시해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiVisionAPI(prompt, currentImageBase64);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">분석에 실패했습니다: ${e.message}</p>`; }
            });

            // Video Upload & Analysis
            const videoUploadWrapper = document.getElementById('videoUploadWrapper');
            const videoUpload = document.getElementById('videoUpload');
            const videoPreview = document.getElementById('videoPreview');
            const videoPreviewContainer = document.getElementById('videoPreviewContainer');

            if (videoUploadWrapper) {
                videoUploadWrapper.addEventListener('click', () => videoUpload.click());
                videoUploadWrapper.addEventListener('dragover', (e) => { e.preventDefault(); videoUploadWrapper.classList.add('dragover'); });
                videoUploadWrapper.addEventListener('dragleave', () => videoUploadWrapper.classList.remove('dragover'));
                videoUploadWrapper.addEventListener('drop', (e) => { e.preventDefault(); videoUploadWrapper.classList.remove('dragover'); if (e.dataTransfer.files.length) handleVideoFile(e.dataTransfer.files[0]); });
            }
            if (videoUpload) videoUpload.addEventListener('change', (e) => { if (e.target.files.length) handleVideoFile(e.target.files[0]); });

            function handleVideoFile(file) {
                const url = URL.createObjectURL(file);
                videoPreview.src = url;
                videoPreviewContainer.classList.remove('hidden');
            }

            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');
            if (analyzeVideoBtn) analyzeVideoBtn.addEventListener('click', async () => {
                const resultContainer = document.getElementById('videoAnalysisResultContainer');
                const resultDiv = document.getElementById('videoAnalysisResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';

                const video = document.getElementById('videoPreview');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const frameBase64 = canvas.toDataURL('image/jpeg').split(',')[1];

                try {
                    const prompt = `당신은 수의사 AI 보조입니다. ${getPetContext()} 이 영상 프레임을 분석해주세요. 반려동물의 자세, 보행 패턴, 행동 등을 관찰하고, 발견되는 이상 소견이나 주의사항을 설명해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiVisionAPI(prompt, frameBase64);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);

                    // Save to session history
                    const now = new Date();
                    const summary = result.substring(0, 50) + '...';
                    videoAnalysisLogs.unshift({
                        id: Date.now().toString(),
                        date: now.toLocaleDateString('ko-KR'),
                        summary: summary,
                        result: result
                    });
                    updateVideoAnalysisHistory(videoAnalysisLogs);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">영상 분석에 실패했습니다: ${e.message}</p>`; }
            });

            // Food Safety Check
            const checkFoodSafetyBtn = document.getElementById('checkFoodSafetyBtn');
            if (checkFoodSafetyBtn) checkFoodSafetyBtn.addEventListener('click', async () => {
                const food = document.getElementById('foodInput').value.trim();
                if (!food) return;
                const resultContainer = document.getElementById('foodSafetyResultContainer');
                const resultDiv = document.getElementById('foodSafetyResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} "${food}"을(를) 이 반려동물이 먹어도 안전한지 분석해주세요. 안전/주의/위험 등급, 먹일 수 있는 양, 주의사항을 알려주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">확인에 실패했습니다: ${e.message}</p>`; }
            });

            // Play Recommendation
            const recommendPlayBtn = document.getElementById('recommendPlayBtn');
            if (recommendPlayBtn) recommendPlayBtn.addEventListener('click', async () => {
                const resultContainer = document.getElementById('playRecommendationResultContainer');
                const resultDiv = document.getElementById('playRecommendationResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} 이 반려동물의 나이와 품종을 고려하여 맞춤형 놀이 활동과 환경 풍부화 아이디어를 5가지 추천해주세요. 각 활동의 구체적인 방법과 기대 효과를 설명해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">추천 생성에 실패했습니다: ${e.message}</p>`; }
            });

            // Handover Note
            const generateHandoverNoteBtn = document.getElementById('generateHandoverNoteBtn');
            if (generateHandoverNoteBtn) generateHandoverNoteBtn.addEventListener('click', async () => {
                const resultContainer = document.getElementById('handoverNoteResultContainer');
                const resultDiv = document.getElementById('handoverNoteResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} 이 반려동물을 펫시터나 병원에 맡길 때 필요한 인수인계 노트를 작성해주세요. 기본 정보, 식사 일정/양, 약물 복용 여부, 행동 특이사항, 긴급 연락처 양식, 주의사항을 포함해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                    setTimeout(() => {
                        const copyBtn = document.getElementById('copyHandoverNoteBtn');
                        if (copyBtn) {
                            copyBtn.addEventListener('click', () => {
                                navigator.clipboard.writeText(result).then(() => {
                                    copyBtn.textContent = '복사됨!';
                                    setTimeout(() => { copyBtn.textContent = '복사하기'; }, 2000);
                                });
                            });
                        }
                    }, 100);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">노트 생성에 실패했습니다: ${e.message}</p>`; }
            });

            // Behavior Analysis
            const analyzeBehaviorBtn = document.getElementById('analyzeBehaviorBtn');
            if (analyzeBehaviorBtn) analyzeBehaviorBtn.addEventListener('click', async () => {
                const behavior = document.getElementById('behaviorInput').value.trim();
                if (!behavior) return;
                const resultContainer = document.getElementById('behaviorResultContainer');
                const resultDiv = document.getElementById('behaviorResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} 보호자 보고 행동: "${behavior}". 이 행동에 대해 가능한 원인, 심리 상태 분석, 건강 문제 가능성, 권장 대처법을 자세히 분석해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">분석에 실패했습니다: ${e.message}</p>`; }
            });

            // Training Plan
            const generateTrainingPlanBtn = document.getElementById('generateTrainingPlanBtn');
            if (generateTrainingPlanBtn) generateTrainingPlanBtn.addEventListener('click', async () => {
                const goal = document.getElementById('trainingInput').value.trim();
                if (!goal) return;
                const resultContainer = document.getElementById('trainingPlanResultContainer');
                const resultDiv = document.getElementById('trainingPlanResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} 훈련 목표: "${goal}". 이 목표를 달성하기 위한 4주간의 단계별 훈련 계획을 작성해주세요. 주차별 목표, 구체적인 훈련 방법, 필요한 도구, 주의사항을 포함해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">계획 생성에 실패했습니다: ${e.message}</p>`; }
            });

            // Emergency Protocol
            const generateEmergencyProtocolBtn = document.getElementById('generateEmergencyProtocolBtn');
            if (generateEmergencyProtocolBtn) generateEmergencyProtocolBtn.addEventListener('click', async () => {
                const situation = document.getElementById('emergencySituation').value;
                const resultContainer = document.getElementById('emergencyProtocolResultContainer');
                const resultDiv = document.getElementById('emergencyProtocolResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} 응급 상황: "${situation}". 이 응급 상황에 대한 단계별 대처 가이드를 작성해주세요. 즉시 해야 할 일, 절대 하면 안 되는 일, 응급 처치 방법, 병원으로 이동 시 주의사항을 포함해주세요. 이것은 참고용이며 즉시 수의사에게 연락해야 함을 명시해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">가이드 생성에 실패했습니다: ${e.message}</p>`; }
            });

            // Cost Estimator
            const estimateCostBtn = document.getElementById('estimateCostBtn');
            if (estimateCostBtn) estimateCostBtn.addEventListener('click', async () => {
                const symptom = document.getElementById('symptomInput').value.trim();
                if (!symptom) return;
                const resultContainer = document.getElementById('costEstimateResultContainer');
                const resultDiv = document.getElementById('costEstimateResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${getPetContext()} 증상/진료 항목: "${symptom}". 한국 기준으로 예상 진료비를 분석해주세요. 초진비, 검사비(혈액/소변/영상), 치료비, 약값 등 항목별 예상 비용 범위를 알려주세요. 지역/병원에 따라 차이가 있을 수 있음을 명시해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">예상 비용 생성에 실패했습니다: ${e.message}</p>`; }
            });

            // Breed Info
            const generateBreedInfoBtn = document.getElementById('generateBreedInfoBtn');
            if (generateBreedInfoBtn) generateBreedInfoBtn.addEventListener('click', async () => {
                const resultContainer = document.getElementById('breedInfoResultContainer');
                const resultDiv = document.getElementById('breedInfoResult');
                resultContainer.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const prompt = `${currentPetData.breed} 품종에 대한 상세 정보를 알려주세요. 기본 특성, 성격, 건강 주의사항, 취약한 질병, 적정 체중 범위, 수명, 사료 권장사항, 그루밍 필요성, 운동량 등을 포함해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    resultDiv.innerHTML = simpleMarkdownToHtml(result);
                } catch (e) { resultDiv.innerHTML = `<p class="text-red-500">품종 정보 생성에 실패했습니다: ${e.message}</p>`; }
            });

            // GPS Location & Map Links
            let userLocation = null;
            const getLocationBtn = document.getElementById('getLocationBtn');
            const locationStatus = document.getElementById('locationStatus');
            const openGoogleMapBtn = document.getElementById('openGoogleMapBtn');
            const openNaverMapBtn = document.getElementById('openNaverMapBtn');

            function enableMapButtons() {
                openGoogleMapBtn.disabled = false;
                openGoogleMapBtn.classList.remove('text-slate-400', 'cursor-not-allowed');
                openGoogleMapBtn.classList.add('text-slate-700');
                openNaverMapBtn.disabled = false;
                openNaverMapBtn.classList.remove('text-slate-400', 'cursor-not-allowed');
                openNaverMapBtn.classList.add('text-slate-700');
            }

            if (getLocationBtn) getLocationBtn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    locationStatus.textContent = '이 브라우저에서는 위치 서비스를 지원하지 않습니다.';
                    locationStatus.classList.add('text-red-500');
                    return;
                }
                locationStatus.textContent = '위치를 확인하는 중...';
                locationStatus.classList.remove('text-red-500');
                getLocationBtn.disabled = true;
                getLocationBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div> 확인 중...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        locationStatus.textContent = `위치 확인 완료! (${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)})`;
                        locationStatus.classList.add('text-green-600');
                        getLocationBtn.disabled = false;
                        getLocationBtn.innerHTML = '<i data-lucide="map-pin" class="w-5 h-5 mr-2"></i> 위치 다시 찾기';
                        lucide.createIcons();
                        enableMapButtons();
                    },
                    (error) => {
                        let msg = '위치를 가져올 수 없습니다.';
                        if (error.code === 1) msg = '위치 권한이 거부되었습니다. 브라우저 설정에서 위치 권한을 허용해주세요.';
                        else if (error.code === 2) msg = '위치 정보를 사용할 수 없습니다.';
                        else if (error.code === 3) msg = '위치 요청 시간이 초과되었습니다.';
                        locationStatus.textContent = msg;
                        locationStatus.classList.add('text-red-500');
                        getLocationBtn.disabled = false;
                        getLocationBtn.innerHTML = '<i data-lucide="map-pin" class="w-5 h-5 mr-2"></i> 내 위치 찾기';
                        lucide.createIcons();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            });

            if (openGoogleMapBtn) openGoogleMapBtn.addEventListener('click', () => {
                if (!userLocation) return;
                const url = `https://www.google.com/maps/search/동물병원/@${userLocation.lat},${userLocation.lng},14z`;
                window.open(url, '_blank');
            });

            if (openNaverMapBtn) openNaverMapBtn.addEventListener('click', () => {
                if (!userLocation) return;
                const url = `https://map.naver.com/p/search/동물병원?c=${userLocation.lng},${userLocation.lat},14,0,0,0,dh`;
                window.open(url, '_blank');
            });

            // Vet AI Search
            const vetSearchBtn = document.getElementById('vetSearchBtn');
            if (vetSearchBtn) vetSearchBtn.addEventListener('click', async () => {
                const query = document.getElementById('vetSearchInput').value.trim();
                if (!query) return;
                const container = document.getElementById('vetResults');
                container.innerHTML = '<div class="col-span-2 flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div></div>';
                try {
                    const locationInfo = userLocation ? `사용자 현재 위치 좌표: ${userLocation.lat}, ${userLocation.lng}.` : '';
                    const prompt = `${getPetContext()} ${locationInfo} 사용자 검색 요청: "${query}". 이 조건에 맞는 동물병원을 추천해주세요. 병원 유형, 추천 이유, 찾을 때 확인해야 할 사항 등을 포함해주세요. 실제 병원이 아닌 참고용 AI 추천임을 명시해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);
                    container.innerHTML = `<div class="col-span-2 bg-white p-6 rounded-xl shadow-sm"><div class="prose max-w-none">${simpleMarkdownToHtml(result)}</div></div>`;
                } catch (e) { container.innerHTML = `<div class="col-span-2 text-red-500 text-center">검색에 실패했습니다: ${e.message}</div>`; }
            });

            // Chat
            const chatForm = document.getElementById('chatForm');
            if (chatForm) chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (!message) return;

                const chatWindow = document.getElementById('chatWindow');

                const userBubble = document.createElement('div');
                userBubble.className = 'flex justify-end';
                userBubble.innerHTML = `<div class="chat-bubble chat-bubble-user p-3 rounded-lg shadow-sm">${message}</div>`;
                chatWindow.appendChild(userBubble);

                const loadingBubble = document.createElement('div');
                loadingBubble.className = 'flex justify-start';
                loadingBubble.id = 'chat-loading';
                loadingBubble.innerHTML = `<div class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm"><div class="animate-pulse">AI가 생각 중...</div></div>`;
                chatWindow.appendChild(loadingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                input.value = '';

                try {
                    const prompt = `당신은 ${currentPetData.name}의 전담 AI 집사입니다. ${getPetContext()} 보호자 질문: "${message}". 친절하고 전문적으로 답변해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);

                    const loading = document.getElementById('chat-loading');
                    if (loading) loading.remove();

                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'flex justify-start';
                    aiBubble.innerHTML = `<div class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm">${simpleMarkdownToHtml(result)}</div>`;
                    chatWindow.appendChild(aiBubble);
                } catch (error) {
                    const loading = document.getElementById('chat-loading');
                    if (loading) loading.remove();

                    const errorBubble = document.createElement('div');
                    errorBubble.className = 'flex justify-start';
                    errorBubble.innerHTML = `<div class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm text-red-500">죄송합니다. 응답 생성에 실패했습니다: ${error.message}</div>`;
                    chatWindow.appendChild(errorBubble);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });

            // Persistent Chat
            const persistentChatForm = document.getElementById('persistentChatForm');
            if (persistentChatForm) persistentChatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('persistentChatInput');
                const message = input.value.trim();
                if (!message) return;

                const chatWindow = document.getElementById('persistentChatWindow');

                const userBubble = document.createElement('div');
                userBubble.className = 'flex justify-end';
                userBubble.innerHTML = `<div class="chat-bubble chat-bubble-user p-3 rounded-lg shadow-sm">${message}</div>`;
                chatWindow.appendChild(userBubble);

                const loadingBubble = document.createElement('div');
                loadingBubble.className = 'flex justify-start';
                loadingBubble.id = 'persistent-chat-loading';
                loadingBubble.innerHTML = `<div class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm"><div class="animate-pulse">AI가 생각 중...</div></div>`;
                chatWindow.appendChild(loadingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                input.value = '';

                try {
                    const prompt = `당신은 ${currentPetData.name}의 전담 AI 집사입니다. ${getPetContext()} 보호자 질문: "${message}". 친절하고 전문적으로 답변해주세요. 한국어로 대답해주세요.`;
                    const result = await callGeminiAPI(prompt);

                    const loading = document.getElementById('persistent-chat-loading');
                    if (loading) loading.remove();

                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'flex justify-start';
                    aiBubble.innerHTML = `<div class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm">${simpleMarkdownToHtml(result)}</div>`;
                    chatWindow.appendChild(aiBubble);
                } catch (error) {
                    const loading = document.getElementById('persistent-chat-loading');
                    if (loading) loading.remove();

                    const errorBubble = document.createElement('div');
                    errorBubble.className = 'flex justify-start';
                    errorBubble.innerHTML = `<div class="chat-bubble chat-bubble-ai p-3 rounded-lg shadow-sm text-red-500">죄송합니다. 응답 생성에 실패했습니다: ${error.message}</div>`;
                    chatWindow.appendChild(errorBubble);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        }
    </script>
</body>
</html>
